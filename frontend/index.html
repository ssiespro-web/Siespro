<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIESPRO – Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fondo: "#050505",
                        fondoPanel: "#0F1623",
                        primario: "#00BFFF", 
                        secundario: "#1E90FF",
                        acento: "#00FFFF",
                        alerta: "#FF4500",
                        success: "#00FF9D",
                        texto: "#FFFFFF",
                        textoGray: "#94A3B8"
                    },
                    fontFamily: { sans: ["Inter", "sans-serif"] },
                    animation: {
                        'pulse-dot': 'pulseDot 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'scroll-up': 'scrollUp 10s linear infinite',
                        'scan-line': 'scanLine 3s linear infinite',
                    },
                    keyframes: {
                        pulseDot: {
                            "0%, 100%": { opacity: 1, transform: "scale(1)" },
                            "50%": { opacity: 0.5, transform: "scale(1.2)" }
                        },
                        scrollUp: {
                            "0%": { transform: "translateY(0)" },
                            "100%": { transform: "translateY(-50%)" }
                        },
                        scanLine: {
                            "0%": { top: "0%" },
                            "100%": { top: "100%" }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Ocultar scrollbar para estética */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #1E90FF; border-radius: 4px; }
        .hidden-section { display: none !important; }
    </style>
</head>

<body class="bg-fondo text-texto font-sans antialiased h-screen flex flex-col">

    <section id="login-section" class="flex-1 flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 opacity-20 pointer-events-none" 
             style="background-image: linear-gradient(#1E90FF 1px, transparent 1px), linear-gradient(90deg, #1E90FF 1px, transparent 1px); background-size: 40px 40px;">
        </div>
        
        <div class="z-10 bg-[#0B1120] p-8 rounded-2xl border border-white/10 shadow-[0_0_50px_rgba(0,191,255,0.1)] w-full max-w-md text-center">
            <div class="mb-6 flex justify-center">
                <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-primario to-acento flex items-center justify-center shadow-[0_0_20px_#00BFFF]">
                    <i class="ph ph-fingerprint text-3xl text-white"></i>
                </div>
            </div>
            <h2 class="text-2xl font-bold mb-2">Acceso Seguro SIESPRO</h2>
            <p class="text-textoGray text-sm mb-8">Ingresa un usuario para generar tu sesión</p>
            
            <form id="login-form" class="space-y-4">
                <input type="text" id="username" placeholder="Nombre de usuario (ej: AdminDemo)" required
                    class="w-full bg-[#0F172A] border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-primario focus:ring-1 focus:ring-primario transition-all placeholder-gray-600">
                
                <button type="submit" 
                    class="w-full py-3 bg-gradient-to-r from-primario to-secundario text-fondo font-bold rounded-lg hover:shadow-[0_0_20px_rgba(0,191,255,0.4)] transition-all">
                    INGRESAR AL SISTEMA
                </button>
            </form>
            <p id="login-error" class="mt-4 text-alerta text-xs hidden"></p>
        </div>
    </section>

    <section id="dashboard-section" class="relative py-12 px-6 overflow-hidden hidden-section min-h-screen">

        <div class="absolute inset-0 opacity-20 pointer-events-none" 
             style="background-image: linear-gradient(#1E90FF 1px, transparent 1px), linear-gradient(90deg, #1E90FF 1px, transparent 1px); background-size: 40px 40px;">
        </div>

        <div class="container mx-auto max-w-7xl relative z-10">

            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-extrabold mb-2">
                    Control Total en 
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-primario to-acento">Tiempo Real</span>
                </h2>
                <div class="flex justify-center items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-success animate-pulse"></span>
                    <p class="text-textoGray text-sm" id="connection-status">Conectado al servidor</p>
                </div>
            </div>

            <div class="relative w-full rounded-2xl overflow-hidden border border-white/10 shadow-2xl bg-[#0B1120] ring-1 ring-white/5">
                
                <div class="h-14 bg-[#0F172A] border-b border-white/5 flex items-center justify-between px-6">
                    <div class="flex items-center gap-4">
                        <div class="flex gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500/50"></div>
                        </div>
                        <div class="h-6 w-px bg-white/10"></div>
                        <span class="text-sm font-mono text-primario tracking-widest">SIESPRO ADMIN</span>
                    </div>
                    <div class="flex items-center gap-4 text-sm text-textoGray">
                        <span id="user-display" class="font-bold text-white">Usuario</span>
                        <button onclick="logout()" class="hover:text-alerta transition-colors"><i class="ph ph-sign-out text-xl"></i></button>
                    </div>
                </div>

                <div class="flex flex-col lg:flex-row h-auto lg:h-[600px]">
                    
                    <div class="w-full lg:w-64 bg-[#0F172A] border-r border-white/5 p-4 flex flex-col gap-2">
                        <div class="p-3 bg-primario/10 text-primario rounded-lg flex items-center gap-3 font-semibold cursor-pointer border border-primario/20">
                            <i class="ph ph-squares-four text-xl"></i> Dashboard
                        </div>
                        <div class="mt-auto p-4 rounded-xl bg-gradient-to-br from-fondo to-[#1e293b] border border-white/5">
                            <p class="text-xs text-textoGray mb-2">Estado API</p>
                            <p id="api-status-text" class="text-right text-xs font-mono text-success mt-1">ONLINE</p>
                        </div>
                    </div>

                    <div class="flex-1 p-6 overflow-y-auto bg-[#0B1120]">
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-[#151E32] p-5 rounded-xl border border-white/5 relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10">
                                    <i class="ph ph-student text-6xl text-primario"></i>
                                </div>
                                <p class="text-textoGray text-sm">Estado Normal (Adentro)</p>
                                <h3 id="count-safe" class="text-3xl font-bold text-white mt-1">--</h3>
                                <div class="mt-4 flex items-center gap-2 text-xs text-success bg-success/10 w-fit px-2 py-1 rounded">
                                    <i class="ph ph-shield-check"></i> Seguros
                                </div>
                            </div>

                            <div class="bg-[#151E32] p-5 rounded-xl border border-white/5 relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10">
                                    <i class="ph ph-siren text-6xl text-alerta"></i>
                                </div>
                                <p class="text-textoGray text-sm">Alertas (Afuera)</p>
                                <h3 id="count-danger" class="text-3xl font-bold text-alerta mt-1">--</h3>
                                <div id="alert-badge" class="mt-4 flex items-center gap-2 text-xs text-textoGray bg-white/5 w-fit px-2 py-1 rounded">
                                    <i class="ph ph-warning"></i> Sin incidentes
                                </div>
                            </div>

                            <div class="bg-[#151E32] p-5 rounded-xl border border-white/5 relative overflow-hidden">
                                <div class="absolute right-0 top-0 p-4 opacity-10">
                                    <i class="ph ph-cpu text-6xl text-acento"></i>
                                </div>
                                <p class="text-textoGray text-sm">Random Forest AI</p>
                                <h3 class="text-3xl font-bold text-acento mt-1">89.0%</h3>
                                <div class="mt-4 flex items-center gap-2 text-xs text-acento bg-acento/10 w-fit px-2 py-1 rounded">
                                    <i class="ph ph-check-circle"></i> Precisión Modelo
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[400px]">
                            
                            <div class="lg:col-span-2 bg-[#151E32] rounded-xl border border-white/5 relative overflow-hidden flex items-center justify-center">
                                <div class="absolute top-4 left-4 z-20 bg-black/50 backdrop-blur px-3 py-1 rounded border border-white/10">
                                    <span class="text-xs font-mono text-white">● MONITOR VISUAL</span>
                                </div>
                                
                                <div class="absolute inset-0 opacity-20" 
                                     style="background-image: linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px); background-size: 50px 50px;">
                                </div>
                                <div class="absolute w-full h-1 bg-acento/30 shadow-[0_0_20px_#00FFFF] animate-scan-line z-10"></div>

                                <div id="map-container" class="relative w-full h-full">
                                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-600 text-sm">
                                        Esperando datos...
                                    </div>
                                </div>
                            </div>

                            <div class="bg-[#151E32] rounded-xl border border-white/5 p-4 flex flex-col overflow-hidden">
                                <h4 class="text-white font-bold mb-4 flex justify-between items-center">
                                    Activity Log
                                    <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-textoGray">Live</span>
                                </h4>
                                
                                <div class="relative flex-1 overflow-y-auto" id="log-container">
                                    </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // ================= CONFIGURACIÓN =================
        // ⚠️ PEGA AQUÍ TU URL DE RENDER (SIN LA BARRA AL FINAL)
        const API_URL = "https://siespro.onrender.com/"; 

        // ================= ESTADO =================
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        let apiKey = localStorage.getItem('siespro_api_key');
        let username = localStorage.getItem('siespro_username');

        // ================= FUNCIONES AUTH =================
        function checkAuth() {
            if (apiKey) {
                showDashboard();
            } else {
                loginSection.classList.remove('hidden-section');
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const errorMsg = document.getElementById('login-error');
            errorMsg.classList.add('hidden');
            errorMsg.innerText = '';

            try {
                // Intentamos crear el usuario para obtener la key
                const response = await fetch(`${API_URL}/auth/create-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user })
                });

                if (response.ok) {
                    const data = await response.json();
                    apiKey = data.api_key;
                    username = data.username;
                    localStorage.setItem('siespro_api_key', apiKey);
                    localStorage.setItem('siespro_username', username);
                    showDashboard();
                } else {
                    // Si falla (ej: usuario ya existe), pedimos que ingrese otro nombre para la demo
                    const err = await response.json();
                    errorMsg.innerText = "El usuario ya existe. Para esta demo, usa un nombre diferente.";
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.innerText = "Error de conexión con el servidor. Verifica la URL.";
                errorMsg.classList.remove('hidden');
                console.error(error);
            }
        });

        function logout() {
            localStorage.removeItem('siespro_api_key');
            localStorage.removeItem('siespro_username');
            location.reload();
        }

        function showDashboard() {
            loginSection.classList.add('hidden-section');
            dashboardSection.classList.remove('hidden-section');
            document.getElementById('user-display').innerText = username || 'Admin';
            startPolling();
        }

        // ================= FUNCIONES DASHBOARD =================
        async function fetchMonitorData() {
            try {
                const response = await fetch(`${API_URL}/sensors/monitor`, {
                    headers: { 'x-api-key': apiKey }
                });
                if (response.status === 401) { logout(); return; } // Token inválido
                return await response.json();
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('connection-status').innerText = "Desconectado";
                document.getElementById('connection-status').classList.add('text-alerta');
                return null;
            }
        }

        function updateUI(devices) {
            if (!devices) return;

            // Contadores
            const safeCount = devices.filter(d => d.current_prediction === 0).length;
            const dangerCount = devices.filter(d => d.current_prediction === 1).length;

            document.getElementById('count-safe').innerText = safeCount;
            document.getElementById('count-danger').innerText = dangerCount;

            // Badge Alerta
            const alertBadge = document.getElementById('alert-badge');
            if (dangerCount > 0) {
                alertBadge.className = "mt-4 flex items-center gap-2 text-xs text-alerta bg-alerta/10 w-fit px-2 py-1 rounded animate-pulse";
                alertBadge.innerHTML = `<i class="ph ph-warning"></i> ${dangerCount} ALERTA(S)`;
            } else {
                alertBadge.className = "mt-4 flex items-center gap-2 text-xs text-success bg-success/10 w-fit px-2 py-1 rounded";
                alertBadge.innerHTML = `<i class="ph ph-check"></i> Zona segura`;
            }

            // Actualizar Log y Mapa
            const logContainer = document.getElementById('log-container');
            const mapContainer = document.getElementById('map-container');
            
            // Limpiar log y mapa para simplificar (en prod haríamos append)
            logContainer.innerHTML = ''; 
            mapContainer.innerHTML = ''; 

            devices.forEach((device, index) => {
                // 1. Agregar al Log
                const time = new Date(device.last_seen).toLocaleTimeString();
                const isDanger = device.current_prediction === 1;
                const statusColor = isDanger ? 'bg-alerta' : 'bg-success';
                const statusText = isDanger ? 'SALIDA DETECTADA' : 'Estado Normal';
                const textColor = isDanger ? 'text-alerta font-bold' : 'text-white';

                const logItem = `
                    <div class="flex items-center gap-3 text-xs p-2 hover:bg-white/5 rounded transition-colors border-b border-white/5">
                        <div class="w-2 h-2 rounded-full ${statusColor} ${isDanger ? 'animate-pulse' : ''}"></div>
                        <span class="text-gray-400">${time}</span>
                        <div class="flex flex-col">
                            <span class="${textColor}">${device.bracelet_id}</span>
                            <span class="text-[10px] text-gray-500">${statusText}</span>
                        </div>
                    </div>
                `;
                logContainer.innerHTML += logItem;

                // 2. Agregar al Mapa (Posiciones aleatorias simuladas para demo visual)
                // Usamos el ID para generar una posición "fija" consistente
                const pseudoRandom = (str) => {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                    return Math.abs(hash);
                };
                
                const topPos = (pseudoRandom(device.bracelet_id) % 60) + 20; // Entre 20% y 80%
                const leftPos = (pseudoRandom(device.bracelet_id + "x") % 60) + 20;

                const dot = document.createElement('div');
                dot.className = `absolute w-4 h-4 rounded-full border-2 border-[#0B1120] ${isDanger ? 'bg-alerta animate-ping' : 'bg-primario'}`;
                dot.style.top = `${topPos}%`;
                dot.style.left = `${leftPos}%`;
                
                // Tooltip simple
                dot.title = `${device.bracelet_id}: ${isDanger ? 'AFUERA' : 'ADENTRO'}`;
                
                // Punto estático encima del ping
                const dotStatic = document.createElement('div');
                dotStatic.className = `absolute w-4 h-4 rounded-full border-2 border-[#0B1120] ${isDanger ? 'bg-alerta' : 'bg-primario'}`;
                dotStatic.style.top = `${topPos}%`;
                dotStatic.style.left = `${leftPos}%`;

                mapContainer.appendChild(dot);
                mapContainer.appendChild(dotStatic);
            });
        }

        function startPolling() {
            // Primera llamada inmediata
            fetchMonitorData().then(updateUI);
            
            // Polling cada 3 segundos
            setInterval(async () => {
                const data = await fetchMonitorData();
                updateUI(data);
            }, 3000);
        }

        // Iniciar
        checkAuth();

    </script>
</body>

</html>
